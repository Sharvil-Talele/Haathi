<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Ludo - Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --cell-size: clamp(20px, 6.6vw, 40px);
      --board-size: calc(var(--cell-size) * 15);
      --token-size: calc(var(--cell-size) * 0.7);
      --home-spot-size: calc(var(--cell-size) * 0.8);
      
      --color-red: #e74c3c;
      --color-red-light: #f5b7b1;
      --color-green: #2ecc71;
      --color-green-light: #a9dfbf;
      --color-yellow: #f1c40f;
      --color-yellow-light: #f9e79f;
      --color-blue: #3498db;
      --color-blue-light: #aed6f1;
      --color-safe: #f9e79f;
    }

    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 1rem;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      max-width: 800px;
      width: 100%;
    }
    
    h1 {
      text-align: center;
      color: #e91e63;
      margin-top: 0;
      font-size: 2rem;
    }
    
    .setup-screen, .game-screen {
      display: none;
    }
    
    .setup-screen.active, .game-screen.active {
      display: block;
    }
    
    .btn {
      background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin: 0.5rem 0;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin: 0.5rem 0;
      box-sizing: border-box;
    }
    
    .room-code-display {
      background: #f0f0f0;
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
      margin: 1rem 0;
    }
    
    .room-code {
      font-size: 2rem;
      font-weight: bold;
      color: #e91e63;
      letter-spacing: 3px;
    }
    
    .info-text {
      text-align: center;
      color: #666;
      margin: 1rem 0;
    }
    
    .ludo-board {
      width: var(--board-size);
      height: var(--board-size);
      margin: 1rem auto;
      position: relative;
      background: #fdfdfd;
      border: 3px solid #333;
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      grid-template-rows: repeat(15, 1fr);
    }
    
    .cell {
      border: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      font-size: 0.6rem;
    }

    .token-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1px;
    }
    
    .home-area {
      position: relative;
    }
    .home-area-red { background: var(--color-red-light); }
    .home-area-green { background: var(--color-green-light); }
    .home-area-yellow { background: var(--color-yellow-light); }
    .home-area-blue { background: var(--color-blue-light); }

    .home-inner {
      position: absolute;
      width: 60%;
      height: 60%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      padding: 10%;
      gap: 10%;
    }
    
    .home-spot {
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      width: var(--home-spot-size);
      height: var(--home-spot-size);
      position: absolute;
    }

    .home-spot-red { background: var(--color-red-light); }
    .home-spot-blue { background: var(--color-blue-light); }
    
    .path-cell {
      background: white;
    }

    .home-path-red { background: var(--color-red-light); }
    .home-path-green { background: var(--color-green-light); }
    .home-path-yellow { background: var(--color-yellow-light); }
    .home-path-blue { background: var(--color-blue-light); }
    
    .start-cell-red { background: var(--color-red-light); }
    .start-cell-green { background: var(--color-green-light); }
    .start-cell-yellow { background: var(--color-yellow-light); }
    .start-cell-blue { background: var(--color-blue-light); }

    .center-cell {
      background: linear-gradient(45deg, var(--color-red-light), var(--color-green-light), var(--color-blue-light), var(--color-yellow-light));
    }
    
    .star-cell::after {
      content: 'â˜…';
      position: absolute;
      font-size: calc(var(--cell-size) * 0.6);
      color: #ffd700;
      z-index: 0;
    }
    
    .token {
      width: var(--token-size);
      height: var(--token-size);
      border-radius: 50%;
      border: 2px solid #333;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: calc(var(--token-size) * 0.5);
      color: white;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
      z-index: 10;
    }

    .token.red { background: var(--color-red); }
    .token.green { background: var(--color-green); }
    .token.yellow { background: var(--color-yellow); }
    .token.blue { background: var(--color-blue); }
    
    .token.movable {
      cursor: pointer;
      box-shadow: 0 0 15px 5px #00ffff;
      animation: pulse 1.2s infinite;
    }
    
    .token.animating {
      box-shadow: 0 0 20px 10px #ff00ff;
      transform: scale(1.2);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    
    .dice-container {
      text-align: center;
      margin: 1rem 0;
      padding: 1rem;
      background: #f9f9f9;
      border-radius: 10px;
    }
    
    .dice {
      width: 80px;
      height: 80px;
      background: white;
      border: 3px solid #333;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: bold;
      cursor: pointer;
      margin: 1rem;
      transition: transform 0.1s;
      user-select: none;
    }
    
    .dice:active {
      transform: scale(0.95);
    }

    .dice.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .dice.rolling {
      animation: roll 0.5s;
    }
    
    @keyframes roll {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1); }
      50% { transform: rotate(180deg) scale(1); }
      75% { transform: rotate(270deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }
    
    .game-info {
      text-align: center;
      margin: 1rem 0;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 1rem;
      background: #f0f0f0;
      border-radius: 10px;
    }
    
    .player-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .player-card {
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .player-card.red { background: var(--color-red-light); }
    .player-card.green { background: var(--color-green-light); }
    .player-card.yellow { background: var(--color-yellow-light); }
    .player-card.blue { background: var(--color-blue-light); }
    
    .player-card.active {
      border-color: #333;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transform: scale(1.05);
    }
    
    .back-btn {
      background: #888;
      padding: 0.8rem 1.5rem;
      width: auto;
      display: inline-block;
      margin-top: 1rem;
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      .dice { width: 60px; height: 60px; font-size: 2rem; }
      .player-info { grid-template-columns: 1fr; }
      .container { padding: 1rem; }
      :root {
        --cell-size: 5.8vw;
      }
      .token {
        font-size: calc(var(--token-size) * 0.6);
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ² Ludo ðŸŽ²</h1>
    
    <div class="setup-screen active" id="setup-screen">
      <p class="info-text">Play Ludo with your partner online! (2 players)</p>
      
      <button class="btn" onclick="createGame()">Create New Game</button>
      
      <div style="text-align: center; margin: 1rem 0; color: #999;">OR</div>
      
      <input type="text" id="room-code-input" placeholder="Enter Room Code" maxlength="6" style="text-transform: uppercase;">
      <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
    </div>
    
    <div class="setup-screen" id="waiting-screen">
      <p class="info-text">Waiting for opponent to join...</p>
      <div class="room-code-display">
        <div>Room Code:</div>
        <div class="room-code" id="display-room-code"></div>
      </div>
      <p class="info-text">Share this code with your partner!</p>
      <button class="btn back-btn" onclick="cancelGame()">Cancel</button>
    </div>
    
    <div class="game-screen" id="game-screen">
      <div class="player-info" id="player-info"></div>
      
      <div class="game-info" id="game-status">Red's Turn</div>
      
      <div class="dice-container">
        <div>Click to roll the dice!</div>
        <div class="dice" id="dice" onclick="rollDice()">ðŸŽ²</div>
        <div id="dice-result" style="min-height: 1.2em; font-weight: bold; margin-top: 0.5rem;"></div>
      </div>
      
      <div class="ludo-board" id="board"></div>
      
      <button class="btn back-btn" onclick="leaveGame()">Leave Game</button>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCcdppTg2pJc9c0iOig_Hp6pDIDAL6_Kjs",
      authDomain: "pari-ca0b5.firebaseapp.com",
      databaseURL: "https://pari-ca0b5-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "pari-ca0b5",
      storageBucket: "pari-ca0b5.firebasestorage.app",
      messagingSenderId: "426313475739",
      appId: "1:426313475739:web:adcb0eb1570a593b62483e"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let currentRoomCode = null;
    let playerNumber = null;
    let myColor = null;
    let gameRef = null;
    let localGameCache = null; // Cache game state to avoid flickering
    let isAnimating = false; // Prevents actions during animation
    const HOP_SPEED_MS = 200; // Speed for token animation

    // --- LUDO LOGIC CONSTANTS ---

    const pathMap = {
      1: { r: 7, c: 2 }, 2: { r: 7, c: 3 }, 3: { r: 7, c: 4 }, 4: { r: 7, c: 5 }, 5: { r: 7, c: 6 },
      6: { r: 6, c: 7 }, 7: { r: 5, c: 7 }, 8: { r: 4, c: 7 }, 9: { r: 3, c: 7 }, 10: { r: 2, c: 7 },
      11: { r: 1, c: 7 }, 12: { r: 1, c: 8 }, 13: { r: 1, c: 9 },
      14: { r: 2, c: 9 }, 15: { r: 3, c: 9 }, 16: { r: 4, c: 9 }, 17: { r: 5, c: 9 }, 18: { r: 6, c: 9 },
      19: { r: 7, c: 10 }, 20: { r: 7, c: 11 }, 21: { r: 7, c: 12 }, 22: { r: 7, c: 13 }, 23: { r: 7, c: 14 },
      24: { r: 7, c: 15 }, 25: { r: 8, c: 15 }, 26: { r: 9, c: 15 },
      27: { r: 9, c: 14 }, 28: { r: 9, c: 13 }, 29: { r: 9, c: 12 }, 30: { r: 9, c: 11 }, 31: { r: 9, c: 10 },
      32: { r: 10, c: 9 }, 33: { r: 11, c: 9 }, 34: { r: 12, c: 9 }, 35: { r: 13, c: 9 }, 36: { r: 14, c: 9 },
      37: { r: 15, c: 9 }, 38: { r: 15, c: 8 }, 39: { r: 15, c: 7 },
      40: { r: 14, c: 7 }, 41: { r: 13, c: 7 }, 42: { r: 12, c: 7 }, 43: { r: 11, c: 7 }, 44: { r: 10, c: 7 },
      45: { r: 9, c: 6 }, 46: { r: 9, c: 5 }, 47: { r: 9, c: 4 }, 48: { r: 9, c: 3 }, 49: { r: 9, c: 2 },
      50: { r: 9, c: 1 }, 51: { r: 8, c: 1 }, 52: { r: 7, c: 1 }
    };
    const redHomePathMap = {
      53: { r: 8, c: 2 }, 54: { r: 8, c: 3 }, 55: { r: 8, c: 4 }, 56: { r: 8, c: 5 }, 57: { r: 8, c: 6 }, 58: { r: 8, c: 7 }
    };
    const blueHomePathMap = {
      53: { r: 8, c: 14 }, 54: { r: 8, c: 13 }, 55: { r: 8, c: 12 }, 56: { r: 8, c: 11 }, 57: { r: 8, c: 10 }, 58: { r: 8, c: 9 }
    };
    const homeSpots = [
      { r: 2, c: 2 }, { r: 2, c: 4 }, { r: 4, c: 2 }, { r: 4, c: 4 }
    ];
    const redHomeSpots = homeSpots.map(s => ({ r: s.r, c: s.c })); // Top-left
    const blueHomeSpots = homeSpots.map(s => ({ r: s.r + 9, c: s.c + 9 })); // Bottom-right
    const safeCells = [1, 9, 14, 22, 27, 35, 40, 48];
    const redStart = 1;
    const blueStart = 27;
    const greenStart = 14;
    const yellowStart = 40;

    // --- GAME FUNCTIONS ---
    
    // Create new game
    function createGame() {
      currentRoomCode = generateRoomCode();
      playerNumber = 1;
      myColor = 'red';
      
      const gameData = {
        players: {
          red: { tokens: [0, 0, 0, 0], finished: 0 },
          blue: { tokens: [0, 0, 0, 0], finished: 0 }
        },
        currentTurn: 'red',
        diceValue: 0,
        canMove: false,
        player1: 'red',
        player2: null,
        status: 'waiting',
        winner: null
      };
      
      database.ref('ludo/' + currentRoomCode).set(gameData).then(() => {
        document.getElementById('display-room-code').textContent = currentRoomCode;
        showScreen('waiting-screen');
        listenForOpponent();
      });
    }
    
    // Join existing game
    function joinGame() {
      const code = document.getElementById('room-code-input').value.toUpperCase().trim();
      if (!code) {
        alert('Please enter a room code!');
        return;
      }
      
      currentRoomCode = code;
      playerNumber = 2;
      myColor = 'blue';
      
      database.ref('ludo/' + currentRoomCode).once('value').then(snapshot => {
        if (!snapshot.exists()) {
          alert('Room not found! Check the code and try again.');
          return;
        }
        
        const game = snapshot.val();
        if (game.player2) {
          alert('This room is already full!');
          return;
        }
        
        database.ref('ludo/' + currentRoomCode + '/player2').set('blue');
        database.ref('ludo/' + currentRoomCode + '/status').set('playing');
        
        startGame();
      });
    }
    
    // Listen for opponent to join
    function listenForOpponent() {
      gameRef = database.ref('ludo/' + currentRoomCode);
      gameRef.on('value', snapshot => {
        const game = snapshot.val();
        if (game && game.status === 'playing') {
          startGame();
        }
      });
    }
    
    // Start the game
    function startGame() {
      showScreen('game-screen');
      initBoard(); 
      
      if (gameRef) gameRef.off(); 

      gameRef = database.ref('ludo/' + currentRoomCode);
      gameRef.on('value', snapshot => {
        const game = snapshot.val();
        if (game) {
          localGameCache = game; // Cache the state
          updateGameDisplay(game); // This now handles token rendering
          
          if (game.winner && game.status === 'finished') {
            setTimeout(() => {
              alert(game.winner.toUpperCase() + ' wins! ðŸŽ‰');
              leaveGame();
            }, 1000);
          }
        } else {
          alert("The game has ended or the opponent left.");
          location.reload();
        }
      }, (error) => {
          console.error(error);
          alert("Lost connection to the game.");
          location.reload();
      });
    }

    // --- UI & RENDER FUNCTIONS ---
    
    // Initialize the Ludo board UI
    function initBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      
      for (let r = 1; r <= 15; r++) {
        for (let c = 1; c <= 15; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell ' + getCellType(r, c);
          cell.id = `cell-r${r}-c${c}`;
          cell.innerHTML = '<div class="token-container"></div>';
          board.appendChild(cell);
        }
      }
    }
    
    // Update game display (Tokens, Status, Dice)
    function updateGameDisplay(game) {
      const statusEl = document.getElementById('game-status');
      const diceEl = document.getElementById('dice');
      const diceResultEl = document.getElementById('dice-result');
      const isMyTurn = game.currentTurn === myColor;

      // Update turn status
      statusEl.textContent = isMyTurn ? "Your Turn!" : "Opponent's Turn...";
      statusEl.style.background = isMyTurn ? '#d4edda' : '#f8d7da';
      
      // Update player cards
      const playerInfoEl = document.getElementById('player-info');
      playerInfoEl.innerHTML = `
        <div class="player-card red ${game.currentTurn === 'red' ? 'active' : ''}">
          ðŸ”´ Red Player ${myColor === 'red' ? '(You)' : ''}
          <br>
          Finished: ${game.players.red.finished} / 4
        </div>
        <div class="player-card blue ${game.currentTurn === 'blue' ? 'active' : ''}">
          ðŸ”µ Blue Player ${myColor === 'blue' ? '(You)' : ''}
          <br>
          Finished: ${game.players.blue.finished} / 4
        </div>
      `;
      
      // **NEW, DEBUGGED DICE UI LOGIC**
      if (isMyTurn) {
        if (game.canMove) {
          // My turn, I've rolled, I need to move
          diceEl.textContent = game.diceValue;
          diceEl.classList.add('disabled');
          diceResultEl.textContent = `You rolled: ${game.diceValue}. Move a token!`;
        } else {
          // My turn, I need to roll (or am re-rolling)
          diceEl.classList.remove('disabled');
          diceResultEl.textContent = "Roll the dice!";
          // Clear the dice face if it's showing an old roll
          diceEl.textContent = 'ðŸŽ²';
        }
      } else {
        // Not my turn
        diceEl.classList.add('disabled');
        if (game.diceValue > 0) {
          // Opponent has rolled or just finished their turn
          diceEl.textContent = game.diceValue;
          diceResultEl.textContent = `Opponent rolled: ${game.diceValue}. Waiting...`;
        } else {
          // Opponent is about to roll
          diceEl.textContent = 'ðŸŽ²';
          diceResultEl.textContent = "Waiting for opponent...";
        }
      }

      // Handle animation lock
      if (isAnimating) {
        diceEl.classList.add('disabled');
      }

      // Render tokens ONLY if not animating
      if (!isAnimating) {
        renderAllTokens(game);
      }
    }

    // Renders tokens based on game state
    function renderAllTokens(game) {
      document.querySelectorAll('.token-container').forEach(c => c.innerHTML = '');

      const isMyTurn = game.currentTurn === myColor;
      const validMoves = (isMyTurn && game.canMove && !isAnimating) 
        ? getValidMoves(myColor, game.diceValue, game.players[myColor].tokens)
        : [];
      
      renderPlayerTokens('red', game.players.red, validMoves);
      renderPlayerTokens('blue', game.players.blue, validMoves);
    }

    function renderPlayerTokens(color, playerState, validMoves) {
      const isMyToken = (color === myColor);

      playerState.tokens.forEach((pos, index) => {
        if (pos === 59) return; // Don't render finished tokens

        const coords = getCoords(color, index, pos);
        if (!coords) return;

        const cell = document.getElementById(`cell-r${coords.r}-c${coords.c}`);
        if (!cell) return;
        
        const tokenContainer = cell.querySelector('.token-container');
        const tokenEl = document.createElement('div');
        tokenEl.className = `token ${color}`;
        tokenEl.textContent = `${color[0].toUpperCase()}${index + 1}`;
        tokenEl.dataset.color = color;
        tokenEl.dataset.index = index;

        if (isMyToken && validMoves.includes(index)) {
          tokenEl.classList.add('movable');
          tokenEl.onclick = () => onTokenClick(color, index);
        }
        
        tokenContainer.appendChild(tokenEl);
      });
    }

    // --- GAME ACTIONS ---
    
    // Roll dice
    function rollDice() {
      if (!localGameCache || localGameCache.currentTurn !== myColor || localGameCache.canMove || isAnimating) {
        return;
      }
      document.getElementById('dice').classList.add('disabled');
      
      // We don't reset diceValue here. The UI logic in updateGameDisplay
      // now handles hiding the old value.

      gameRef.once('value').then(snapshot => {
        const game = snapshot.val();
        
        if (game.currentTurn !== myColor || game.canMove) {
          return; 
        }
        
        const dice = document.getElementById('dice');
        const diceResultEl = document.getElementById('dice-result');
        dice.classList.add('rolling');
        
        setTimeout(() => {
          const roll = Math.floor(Math.random() * 6) + 1;
          dice.textContent = roll;
          dice.classList.remove('rolling');
          
          const myTokens = game.players[myColor].tokens;
          const validMoves = getValidMoves(myColor, roll, myTokens);

          const updates = {
            diceValue: roll
          };

          if (validMoves.length === 0) {
            diceResultEl.textContent = `You rolled: ${roll}. No moves!`;
            updates.canMove = false;
            updates.currentTurn = (myColor === 'red' ? 'blue' : 'red');
            
            setTimeout(() => {
              gameRef.update(updates);
            }, 1500); 

          } else {
            diceResultEl.textContent = `You rolled: ${roll}. Move a token!`;
            updates.canMove = true;
            gameRef.update(updates);
          }
          
        }, 500);
      });
    }
    
    // Animation controller for clicking a token
    function onTokenClick(color, tokenIndex) {
      if (isAnimating || color !== myColor) return;

      isAnimating = true;
      const tokenEl = document.querySelector(`.token[data-color="${color}"][data-index="${tokenIndex}"]`);
      if (!tokenEl) {
        isAnimating = false;
        return;
      }

      document.getElementById('dice').classList.add('disabled');
      document.querySelectorAll('.token.movable').forEach(t => {
        t.classList.remove('movable');
        t.onclick = null;
      });
      tokenEl.classList.add('animating');

      const game = localGameCache;
      const diceValue = game.diceValue;
      const currentPos = game.players[color].tokens[tokenIndex];
      let step = 1;

      function hop() {
        if (step > diceValue) {
          tokenEl.classList.remove('animating');
          runMoveTransaction(color, tokenIndex); // This will set isAnimating = false
          return;
        }

        let nextPos;
        if (currentPos === 0) { // Moving from yard
          nextPos = 1;
          step = diceValue + 1; // End loop, it's one move
        } else {
          nextPos = currentPos + step;
          if (currentPos > 0 && currentPos <= 52 && nextPos > 52) { // Entering home path
            nextPos = 52 + (nextPos - currentPos);
          }
        }
        
        const coords = getCoords(color, tokenIndex, nextPos);
        if (coords) {
          const targetCell = document.getElementById(`cell-r${coords.r}-c${coords.c}`);
          if (targetCell) {
            targetCell.querySelector('.token-container').appendChild(tokenEl);
          }
        }
        
        if (currentPos !== 0) {
          step++;
        }
        
        setTimeout(hop, HOP_SPEED_MS);
      }
      hop();
    }

   // Runs the database update *after* animation
    function runMoveTransaction(color, tokenIndex) {
      gameRef.transaction(game => {
        if (!game) return;
        if (game.currentTurn !== myColor || !game.canMove) return;

        const diceValue = game.diceValue;
        const myTokens = game.players[myColor].tokens;
        const currentPos = myTokens[tokenIndex];

        const validMoves = getValidMoves(myColor, diceValue, myTokens);
        if (!validMoves.includes(tokenIndex)) return;

        let newPos = currentPos + diceValue;
        let getsExtraTurn = false;

        if (currentPos === 0) {
          newPos = 1; 
        } else if (currentPos >= 1 && currentPos <= 52 && newPos > 52) {
          newPos = 52 + (newPos - 52);
        }
        
        if (newPos === 58) {
          game.players[myColor].tokens[tokenIndex] = 59;
          game.players[myColor].finished++;
          getsExtraTurn = true;
        } else {
          game.players[myColor].tokens[tokenIndex] = newPos;
        }

        if (game.players[myColor].finished === 4) {
          game.winner = myColor;
          game.status = 'finished';
        } else {
          // Check for "kill"
          if (newPos >= 1 && newPos <= 52) {
            const absPos = getAbsolutePosition(myColor, newPos);
            if (!safeCells.includes(absPos)) {
              const opponentColor = (myColor === 'red' ? 'blue' : 'red');
              const opponentTokens = game.players[opponentColor].tokens;
              
              for (let i = 0; i < 4; i++) {
                if (opponentTokens[i] > 0 && opponentTokens[i] <= 52) {
                  const oppAbsPos = getAbsolutePosition(opponentColor, opponentTokens[i]);
                  if (oppAbsPos === absPos) {
                    game.players[opponentColor].tokens[i] = 0;
                    getsExtraTurn = true;
                  }
                }
              }
            }
          }

          if (diceValue === 6) {
            getsExtraTurn = true;
          }

          if (getsExtraTurn) {
            game.currentTurn = myColor;
            game.canMove = false;
          } else {
            game.currentTurn = (myColor === 'red' ? 'blue' : 'red');
            game.canMove = false;
          }
        }
        
        return game;
      }).then(() => {
        // ** THIS IS THE FIX **
        isAnimating = false; // Animation and transaction are complete
        
        // The Firebase listener already updated the localGameCache,
        // but the UI was drawn while isAnimating was true.
        // We manually re-run updateGameDisplay() NOW that 
        // isAnimating is false, which will correctly enable the dice.
        if (localGameCache) {
          updateGameDisplay(localGameCache);
        }
      });
    }

    // --- BOARD & UTILITY FUNCTIONS ---

    function getCellType(r, c) {
      if (r >= 1 && r <= 6 && c >= 1 && c <= 6) return 'home-area home-area-red';
      if (r >= 1 && r <= 6 && c >= 10 && c <= 15) return 'home-area home-area-green';
      if (r >= 10 && r <= 15 && c >= 1 && c <= 6) return 'home-area home-area-yellow';
      if (r >= 10 && r <= 15 && c >= 10 && c <= 15) return 'home-area home-area-blue';
      if (r >= 7 && r <= 9 && c >= 7 && c <= 9) return 'center-cell';
      if (c == 8 && r >= 2 && r <= 7) return 'path-cell home-path-green';
      if (c == 8 && r >= 9 && r <= 14) return 'path-cell home-path-yellow';
      if (r == 8 && c >= 2 && c <= 7) return 'path-cell home-path-red';
      if (r == 8 && c >= 9 && c <= 14) return 'path-cell home-path-blue';
      for (let i = 1; i <= 52; i++) {
        if (pathMap[i].r === r && pathMap[i].c === c) {
          let classes = 'path-cell';
          if (i === redStart) classes += ' start-cell-red';
          if (i === greenStart) classes += ' start-cell-green';
          if (i === blueStart) classes += ' start-cell-blue';
          if (i === yellowStart) classes += ' start-cell-yellow';
          if (safeCells.includes(i)) classes += ' star-cell';
          return classes;
        }
      }
      return 'empty-cell';
    }

    function getAbsolutePosition(color, relativePos) {
      if (relativePos === 0 || relativePos > 52) return -1;
      if (color === 'red') return relativePos;
      if (color === 'blue') return ((relativePos - 1 + (blueStart - 1)) % 52) + 1;
      return -1;
    }

    function getCoords(color, tokenIndex, tokenPos) {
      if (tokenPos === 0) {
        if (color === 'red') return redHomeSpots[tokenIndex];
        if (color === 'blue') return blueHomeSpots[tokenIndex];
      }
      if (tokenPos >= 53 && tokenPos <= 58) {
        if (color === 'red') return redHomePathMap[tokenPos];
        if (color === 'blue') return blueHomePathMap[tokenPos];
      }
      if (tokenPos >= 1 && tokenPos <= 52) {
        const absPos = getAbsolutePosition(color, tokenPos);
        return pathMap[absPos];
      }
      return null; // Finished
    }

    function getValidMoves(color, diceValue, tokens) {
      const validMoves = [];
      for (let i = 0; i < 4; i++) {
        const pos = tokens[i];
        if (pos === 59) continue; 
        if (pos === 0 && diceValue === 6) {
          validMoves.push(i);
        } else if (pos > 0) {
          const newPos = pos + diceValue;
          if (pos >= 53 && pos <= 57) {
            if (newPos <= 58) validMoves.push(i);
          } else if (pos >= 1 && pos <= 52) {
            if (newPos <= 58) validMoves.push(i);
          }
        }
      }
      return validMoves;
    }
    
    // --- BASIC UI FUNCTIONS ---

    function showScreen(screenId) {
      document.querySelectorAll('.setup-screen, .game-screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
    }
    
    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    function cancelGame() {
      if (currentRoomCode) {
        // This is the corrected line that had a typo
        database.ref('ludo/' + currentRoomCode).remove();
      }
      location.reload();
    }
    
    function leaveGame() {
      if (gameRef) {
        gameRef.off();
      }
      if (currentRoomCode) {
        database.ref('ludo/' + currentRoomCode).remove();
      }
      location.reload();
    }
  </script>
</body>
</html>
